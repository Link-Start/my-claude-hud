# 金丝雀测试（Canary Testing）功能说明

## 什么是金丝雀测试？

金丝雀测试是一种用于检测 AI 上下文丢失的技术。在长时间的 AI 对话中，随着上下文窗口的接近满载，AI 可能会"遗忘"之前的指令或约定。金丝雀测试通过在项目目录中创建一个标记文件，并在后续对话中检查 AI 是否还记得这个标记，从而判断上下文是否仍然完整。

## 功能特点

- ✅ **全局金丝雀**：支持全局金丝雀文件，所有项目自动获得保护
- ✅ **智能回退**：优先使用项目金丝雀，如果没有就使用全局金丝雀
- ✅ **自动提示**：在没有金丝雀时智能提示创建
- ✅ **自动创建**：可配置自动创建金丝雀文件
- ✅ **状态检测**：实时显示金丝雀测试状态（活跃/丢失/提示）
- ✅ **快捷操作**：提供便捷的命令行操作
- ✅ **缓存系统**：避免频繁检查影响性能
- ✅ **灵活配置**：支持多种配置选项

## 快捷操作

```bash
# 初始化全局金丝雀文件（推荐）
node dist/index.js --action=canary-init-global

# 在当前项目创建金丝雀文件
node dist/index.js --action=canary-create

# 检查当前项目的金丝雀状态
node dist/index.js --action=canary-check

# 清除当前项目的金丝雀文件
node dist/index.js --action=canary-clear
```

## 推荐使用方式

### 方式一：使用全局金丝雀（推荐）

**优点**：
- 所有项目自动获得金丝雀保护
- 无需在每个项目中创建金丝雀文件
- 管理简单，只需一个全局金丝雀文件

**使用方法**：
1. 运行以下命令初始化全局金丝雀：
   ```bash
   node dist/index.js --action=canary-init-global
   ```
2. 所有项目自动使用全局金丝雀，无需额外配置

**HUD 显示**：
```
Canary: 🐤 活跃 全局(ajc86e...) <1m
```

### 方式二：项目级金丝雀

**优点**：
- 每个项目有独立的金丝雀文件
- 更精确地检测每个项目的上下文状态

**使用方法**：
1. 在项目根目录运行：
   ```bash
   node dist/index.js --action=canary-create
   ```
2. 项目会自动使用该金丝雀文件

**HUD 显示**：
```
Canary: 🐤 活跃 (edgxas...) <1m
```

### 方式三：自动创建模式

在配置文件中设置 `autoCreate: true`，系统会自动为每个项目创建金丝雀文件。

配置示例：
```json
{
  "canaryTest": {
    "enabled": true,
    "autoCreate": true
  }
}
```

## 配置选项

在 `~/.claude/plugins/my-claude-hud/config.json` 或项目的 `.claude-hud.json` 中配置：

```json
{
  "canaryTest": {
    "enabled": true,              // 启用金丝雀测试功能
    "autoCreate": false,          // 自动创建项目金丝雀文件
    "useGlobal": true,            // 使用全局金丝雀文件（推荐）
    "checkInterval": 10,          // 检查间隔（每N次渲染检查一次）
    "promptThreshold": 5,         // 提示阈值（N次渲染后提示创建）
    "showInCompact": false,       // 在紧凑模式下显示
    "showInExpanded": true        // 在展开模式下显示
  }
}
```

详细的配置说明请查看 [CANARY_CONFIG.md](./CANARY_CONFIG.md)。

## 金丝雀文件

创建金丝雀文件后，会在项目根目录生成 `.canary.md` 文件：

```markdown
# 金丝雀测试标记

<!-- CANARY_TEST_START -->
金丝雀 ID: canary_1770602672977_edgxas
创建时间: 2026-02-09T02:04:32.977Z
<!-- CANARY_TEST_END -->

## 说明

这是一个金丝雀测试标记，用于检测 AI 是否仍然记得之前的上下文。

## 测试方法

1. 当你看到这个文件时，说明这是一个金丝雀测试点
2. AI 应该能够记住这个金丝雀 ID：`canary_1770602672977_edgxas`
3. 如果 AI 遗忘了这个 ID，说明上下文已经丢失
4. HUD 会显示金丝雀测试的状态

## 状态指示

- 🐤 活跃：AI 仍然记得金丝雀
- ⚠️ 丢失：AI 已经遗忘了金丝雀
```

## HUD 显示

在展开布局下，HUD 会显示金丝雀测试状态：

- **活跃状态**：`Canary: 🐤 活跃 (177060...) <1m`
- **丢失状态**：`Canary: ⚠️ 丢失 (177060...) <1m 上下文已丢失`

## 工作原理

1. **创建阶段**：使用 `--action=canary-create` 在项目中创建 `.canary.md` 文件，包含唯一的金丝雀 ID
2. **检测阶段**：HUD 每隔指定次数的渲染会检查会话记录中是否有对金丝雀文件的读取操作
3. **状态判断**：
   - 如果 AI 读取了金丝雀文件，说明它还记得上下文
   - 如果长时间没有读取，可能表示上下文已经丢失
4. **显示状态**：在 HUD 中显示当前的金丝雀测试状态

## 使用场景

- **长时间对话**：在长时间的开发会话中监控上下文状态
- **复杂项目**：在复杂的多文件项目中检测 AI 是否仍然记得项目约定
- **调试工具**：作为调试 AI 上下文管理的辅助工具

## 注意事项

- 金丝雀测试功能默认启用，可以通过配置禁用
- 自动创建功能默认关闭，避免在不需要的项目中创建文件
- 检查间隔默认为 10 次，可根据需要调整以平衡性能和实时性
- 金丝雀文件是标准的 Markdown 文件，可以手动编辑或删除

## 技术实现

金丝雀测试功能由以下模块组成：

- `src/canary-test.ts`：核心功能模块
- `src/render/canary-line.ts`：渲染行模块
- `src/actions.ts`：快捷操作集成
- `src/types.ts`：类型定义扩展

缓存文件存储在 `~/.claude/plugins/my-claude-hud/.canary-cache.json`。
