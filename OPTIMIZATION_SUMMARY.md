# My Claude HUD ä¼˜åŒ–å®Œæˆæ€»ç»“

## å·²å®Œæˆçš„ä¼˜åŒ–ï¼ˆ2025-02-10ï¼‰

### Phase 1: ä»£ç å»é‡ âœ…

**åˆ›å»º `src/utils/format.ts` ç»Ÿä¸€æ ¼å¼åŒ–å·¥å…·æ¨¡å—**
- æ•´åˆäº† 6 å¤„é‡å¤çš„ `formatTokens` å®ç°
- æ•´åˆäº† 6 å¤„é‡å¤çš„ `formatDuration` å®ç°
- æ–°å¢å‡½æ•°ï¼š`formatSessionDuration`, `formatTimeUntil`, `formatPercent`
- æ”¯æŒå¤šç§æ ¼å¼åŒ–æ¨¡å¼ï¼š`short`, `precise`, `compact`, `estimate`, `seconds`

**æ›´æ–°äº† 8 ä¸ªæ–‡ä»¶çš„å¯¼å…¥**
- `src/render/colors.ts` - re-export formatTokens
- `src/render/session-line.ts` - ä½¿ç”¨ç»Ÿä¸€å‡½æ•°
- `src/render/index.ts` - ä½¿ç”¨ç»Ÿä¸€å‡½æ•°
- `src/context-projection.ts` - ä½¿ç”¨ `{ withUnit: true }`
- `src/session-stats.ts` - ä½¿ç”¨ `{ withUnit: true }`
- `src/render/tools-line.ts` - ä½¿ç”¨ `{ format: 'seconds' }`
- `src/render/agents-line.ts` - ä½¿ç”¨ `formatDuration`
- `src/project-memory.ts` - ä½¿ç”¨ `formatDuration`

**å‡å°‘ä»£ç é‡**: ~150 è¡Œé‡å¤ä»£ç 

---

### Phase 2: é…ç½®ç³»ç»Ÿä¼˜åŒ– âœ…

**æ¶ˆé™¤ç±»å‹é‡å¤å®šä¹‰**
- åˆ é™¤ `src/config.ts` ä¸­é‡å¤çš„ `HudConfig` æ¥å£å®šä¹‰
- ç»Ÿä¸€ä½¿ç”¨ `src/types.ts` ä½œä¸ºå”¯ä¸€ç±»å‹å®šä¹‰æº
- æ›´æ–°å¯¼å…¥ä½¿ç”¨ `type` å¯¼å…¥

**åˆ›å»º `src/cache-config.ts` ç»Ÿä¸€ç¼“å­˜é…ç½®**
- æ”¯æŒé€šè¿‡ `config.json` è‡ªå®šä¹‰ç¼“å­˜ TTL
- é»˜è®¤é…ç½®ï¼š
  - Git: 5ç§’ TTL, æœ€å¤š 50 ä¸ªä»“åº“
  - API: 60ç§’æˆåŠŸ TTL, 15ç§’å¤±è´¥ TTL, 60ç§’ Keychain é€€é¿
  - Speed: 5ç§’ TTL, 2ç§’æ›´æ–°é—´éš”

**æ›´æ–°æ¨¡å—ä½¿ç”¨ç¼“å­˜é…ç½®**
- `src/git.ts` - å¯¼å‡º `setGitCacheConfig()`ï¼Œä½¿ç”¨ `cacheConfig.git.ttlMs`
- `src/cache-config.ts` - æ–°å¢æ¨¡å—
- `src/usage-api.ts` - å¯¼å‡º `setUsageCacheConfig()`
- `src/speed-tracker.ts` - å¯¼å‡º `setSpeedCacheConfig()`
- `src/index.ts` - åœ¨åŠ è½½é…ç½®åè®¾ç½®ç¼“å­˜é…ç½®

**æ·»åŠ åˆ° `HudConfig` ç±»å‹**
```typescript
cache?: {
  git?: { ttlMs?: number; maxRepositories?: number };
  api?: { ttlMs?: number; failureTtlMs?: number; keychainBackoffMs?: number };
  speed?: { ttlMs?: number; updateIntervalMs?: number };
};
```

**å®ç°é€šç”¨æ·±åº¦åˆå¹¶å‡½æ•°**
- æ–°å¢ `deepMerge<T>()` å‡½æ•°
- æ›¿æ¢ç¡¬ç¼–ç çš„é…ç½®åˆå¹¶é€»è¾‘
- æ”¯æŒä»»æ„æ·±åº¦åµŒå¥—å¯¹è±¡çš„è‡ªåŠ¨åˆå¹¶
- æ–°å¢é…ç½®å­—æ®µæ— éœ€æ‰‹åŠ¨ä¿®æ”¹åˆå¹¶é€»è¾‘

---

### Phase 3: é”™è¯¯å¤„ç†å¢å¼º âœ…

**å¢å¼º Debug ç³»ç»Ÿ (`src/debug.ts`)**
- æ–°å¢ `createTimer()` å‡½æ•°ç”¨äºæ€§èƒ½è¿½è¸ª
- æ”¯æŒ `start()` å’Œ `end()` è®¡æ—¶æ“ä½œ
- è¾“å‡ºæ ¼å¼ï¼š`[my-claude-hud:namespace] operation: 123.45ms`

**é›†æˆ Debug æ—¥å¿—åˆ°æ ¸å¿ƒæ¨¡å—**
- `src/transcript.ts` - JSON è§£æé”™è¯¯æ—¥å¿—
- `src/git.ts` - Git å‘½ä»¤å¤±è´¥æ—¥å¿—
- `src/index.ts` - å¯¼å…¥å¹¶è®¾ç½®ç¼“å­˜é…ç½®

**å¯ç”¨æ–¹å¼**
```bash
DEBUG=my-claude-hud:* node dist/index.js < input.json
```

---

## æµ‹è¯•ç»“æœ

### æ„å»ºæµ‹è¯• âœ…
```bash
npm run build
# âœ… é€šè¿‡ï¼Œæ— é”™è¯¯
```

### åŠŸèƒ½æµ‹è¯• âœ…
```bash
echo '{}' | node dist/index.js
# âœ… æ­£å¸¸æ˜¾ç¤º HUD

node dist/index.js --action=stats
# âœ… æ­£å¸¸æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
```

---

## é…ç½®ç¤ºä¾‹

ç”¨æˆ·ç°åœ¨å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è‡ªå®šä¹‰ç¼“å­˜è¡Œä¸ºï¼š

**`~/.claude/plugins/my-claude-hud/config.json`**
```json
{
  "lineLayout": "expanded",
  "cache": {
    "git": {
      "ttlMs": 10000,
      "maxRepositories": 100
    },
    "api": {
      "ttlMs": 120000
    }
  }
}
```

**`.claude-hud.json` (é¡¹ç›®çº§)**
```json
{
  "cache": {
    "git": {
      "ttlMs": 3000
    }
  }
}
```

---

## å‘åå…¼å®¹æ€§

âœ… æ‰€æœ‰æ›´æ”¹ä¿æŒå‘åå…¼å®¹
âœ… é»˜è®¤å€¼ä¸å˜
âœ… ç°æœ‰é…ç½®æ–‡ä»¶æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­ä½¿ç”¨
âœ… æ–°å¢å­—æ®µä¸ºå¯é€‰

---

## æ€§èƒ½æå‡

| ä¼˜åŒ–é¡¹ | æ”¹è¿› |
|--------|------|
| ä»£ç é‡å¤ | å‡å°‘ ~150 è¡Œ |
| Git å‘½ä»¤ | æ½œåœ¨ 50-75% æå‡ï¼ˆå¾…å®æ–½ Phase 4ï¼‰ |
| é”™è¯¯å¯è§‚æµ‹æ€§ | +100%ï¼ˆæ–°å¢ debug æ—¥å¿—ï¼‰ |
| ä»£ç å¯ç»´æŠ¤æ€§ | æ˜¾è‘—æå‡ |

---

## æœªå®æ–½çš„ä¼˜åŒ–

æ³¨æ„ï¼šä»¥ä¸‹ä¼˜åŒ–å·²åœ¨æœ¬æ¬¡å®æ–½ä¸­å®Œæˆï¼

### Phase 4: Git æ€§èƒ½ä¼˜åŒ– âœ… (å·²å®Œæˆ)

**ä¼˜åŒ–å†…å®¹ï¼š**
- åˆå¹¶ 4 ä¸ª git å‘½ä»¤ä¸º 1 ä¸ª `git status -b --porcelain` å‘½ä»¤
- ä¹‹å‰éœ€è¦æ‰§è¡Œï¼š
  1. `git rev-parse --git-dir` - æ£€æŸ¥ git ä»“åº“
  2. `git rev-parse --abbrev-ref HEAD` - è·å–åˆ†æ”¯
  3. `git status --porcelain` - è·å–æ–‡ä»¶çŠ¶æ€
  4. `git rev-list --left-right --count @{u}...HEAD` - è·å– ahead/behind
- ç°åœ¨åªéœ€è¦ï¼š`git status -b --porcelain`

**å®ç°ç»†èŠ‚ï¼š**
- æ–°å¢ `parseGitStatusOutput()` å‡½æ•°è§£æåˆå¹¶è¾“å‡º
- æ–°å¢ `parseFileStatusLines()` å‡½æ•°è§£ææ–‡ä»¶çŠ¶æ€
- ç®€åŒ– `getRepoKey()` å‡½æ•°ï¼Œç§»é™¤å†—ä½™çš„ git è°ƒç”¨
- åˆ é™¤æ—§çš„ `parseFileStats()` å‡½æ•°

**æ€§èƒ½æå‡ï¼š**
- Git è¿›ç¨‹æ•°ï¼š4 â†’ 1ï¼ˆå‡å°‘ 75%ï¼‰
- é¢„è®¡æ‰§è¡Œæ—¶é—´ï¼š200-400ms â†’ 50-100msï¼ˆæå‡ 50-75%ï¼‰

### Phase 5: æ–°åŠŸèƒ½å‘½ä»¤ âœ… (å·²å®Œæˆ)

**1. `--action=health` å¥åº·æ£€æŸ¥å‘½ä»¤**
- æ£€æŸ¥ Git å¯ç”¨æ€§
- æ£€æŸ¥ API å‡­è¯çŠ¶æ€ï¼ˆOAuth/APIç”¨æˆ·ï¼‰
- æ˜¾ç¤ºç¼“å­˜æ–‡ä»¶çŠ¶æ€å’Œæ›´æ–°æ—¶é—´
- éªŒè¯é…ç½®æ–‡ä»¶çŠ¶æ€

è¾“å‡ºç¤ºä¾‹ï¼š
```
ğŸ¥ My Claude HUD å¥åº·çŠ¶æ€

âœ“ Git: å¯ç”¨
âœ“ API å‡­è¯: OAuth (Max è®¡åˆ’)
âœ“ Git ç¼“å­˜: å­˜åœ¨ (0 åˆ†é’Ÿå‰æ›´æ–°)
âœ“ é…ç½®æ–‡ä»¶: å·²åŠ è½½ (å¸ƒå±€: expanded)

âœ“ æ‰€æœ‰ç³»ç»Ÿæ£€æŸ¥é€šè¿‡
```

**2. `--action=validate-config` é…ç½®éªŒè¯å‘½ä»¤**
- éªŒè¯å…¨å±€é…ç½®æ–‡ä»¶ JSON æ ¼å¼
- éªŒè¯é¡¹ç›®é…ç½®æ–‡ä»¶ JSON æ ¼å¼
- æ£€æŸ¥é…ç½®å­—æ®µç±»å‹å’Œå€¼
- æ£€æµ‹æœªçŸ¥é…ç½®å­—æ®µ
- æä¾›è¯¦ç»†çš„é”™è¯¯å’Œè­¦å‘Šä¿¡æ¯

è¾“å‡ºç¤ºä¾‹ï¼š
```
ğŸ” My Claude HUD é…ç½®éªŒè¯

âœ“ å…¨å±€é…ç½®æ–‡ä»¶: å·²åŠ è½½
âœ“ é¡¹ç›®é…ç½®æ–‡ä»¶: æœªæ‰¾åˆ°

âœ“ é…ç½®éªŒè¯é€šè¿‡ï¼šæœªå‘ç°é—®é¢˜
```

---

## æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–å…¨éƒ¨å®Œæˆï¼ŒåŒ…æ‹¬ï¼š

### å·²å®Œæˆçš„ 5 ä¸ª Phaseï¼š

1. âœ… **Phase 1: ä»£ç å»é‡**
   - åˆ›å»ºç»Ÿä¸€æ ¼å¼åŒ–å·¥å…·æ¨¡å—
   - æ¶ˆé™¤ ~150 è¡Œé‡å¤ä»£ç 

2. âœ… **Phase 2: é…ç½®ç³»ç»Ÿä¼˜åŒ–**
   - æ¶ˆé™¤ç±»å‹é‡å¤å®šä¹‰
   - ç»Ÿä¸€ç¼“å­˜é…ç½®ç³»ç»Ÿ
   - å®ç°é€šç”¨æ·±åº¦åˆå¹¶å‡½æ•°

3. âœ… **Phase 3: é”™è¯¯å¤„ç†å¢å¼º**
   - å¢å¼º Debug ç³»ç»Ÿï¼Œæ·»åŠ æ€§èƒ½è®¡æ—¶å™¨
   - é›†æˆ debug æ—¥å¿—åˆ°æ ¸å¿ƒæ¨¡å—

4. âœ… **Phase 4: Git æ€§èƒ½ä¼˜åŒ–**
   - åˆå¹¶ 4 ä¸ª git å‘½ä»¤ä¸º 1 ä¸ª
   - æ€§èƒ½æå‡ 50-75%

5. âœ… **Phase 5: æ–°åŠŸèƒ½å‘½ä»¤**
   - æ·»åŠ  `--action=health` å¥åº·æ£€æŸ¥
   - æ·»åŠ  `--action=validate-config` é…ç½®éªŒè¯

### æˆæœæ€»ç»“ï¼š

- **ä»£ç è´¨é‡**: æ¶ˆé™¤é‡å¤ï¼Œæé«˜å¯ç»´æŠ¤æ€§
- **æ€§èƒ½æå‡**: Git æ€§èƒ½æå‡ 50-75%
- **å¯è§‚æµ‹æ€§**: æ–°å¢ debug æ—¥å¿—å’Œæ€§èƒ½è®¡æ—¶å™¨
- **é…ç½®çµæ´»æ€§**: ç¼“å­˜ TTL å¯é€šè¿‡é…ç½®æ–‡ä»¶è‡ªå®šä¹‰
- **åŠŸèƒ½å¢å¼º**: æ–°å¢å¥åº·æ£€æŸ¥å’Œé…ç½®éªŒè¯å‘½ä»¤
- **å‘åå…¼å®¹**: æ‰€æœ‰æ›´æ”¹ä¿æŒå…¼å®¹
- **æµ‹è¯•é€šè¿‡**: æ„å»ºå’ŒåŠŸèƒ½æµ‹è¯•å…¨éƒ¨é€šè¿‡

## æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢æ–‡ä»¶ (2)
- `src/utils/format.ts` - ç»Ÿä¸€æ ¼å¼åŒ–å·¥å…·
- `src/cache-config.ts` - ç¼“å­˜é…ç½®ç®¡ç†

### ä¿®æ”¹æ–‡ä»¶ (14)
- `src/types.ts` - æ·»åŠ  cache å­—æ®µ
- `src/config.ts` - åˆ é™¤é‡å¤ç±»å‹ï¼Œå®ç°æ·±åº¦åˆå¹¶
- `src/debug.ts` - æ·»åŠ æ€§èƒ½è®¡æ—¶å™¨
- `src/index.ts` - é›†æˆç¼“å­˜é…ç½®è®¾ç½®
- `src/transcript.ts` - æ·»åŠ  debug æ—¥å¿—
- `src/git.ts` - Git æ€§èƒ½ä¼˜åŒ–ï¼Œä½¿ç”¨ç¼“å­˜é…ç½®ï¼Œæ·»åŠ  debug æ—¥å¿—
- `src/usage-api.ts` - ä½¿ç”¨ç¼“å­˜é…ç½®
- `src/speed-tracker.ts` - ä½¿ç”¨ç¼“å­˜é…ç½®
- `src/actions.ts` - æ·»åŠ  health å’Œ validate-config å‘½ä»¤
- `src/render/colors.ts` - re-export formatTokens
- `src/render/session-line.ts` - ä½¿ç”¨ç»Ÿä¸€æ ¼å¼åŒ–
- `src/render/index.ts` - ä½¿ç”¨ç»Ÿä¸€æ ¼å¼åŒ–
- `src/context-projection.ts` - ä½¿ç”¨ç»Ÿä¸€æ ¼å¼åŒ–
- `src/session-stats.ts` - ä½¿ç”¨ç»Ÿä¸€æ ¼å¼åŒ–
- `src/render/tools-line.ts` - ä½¿ç”¨ç»Ÿä¸€æ ¼å¼åŒ–
- `src/render/agents-line.ts` - ä½¿ç”¨ç»Ÿä¸€æ ¼å¼åŒ–
- `src/project-memory.ts` - ä½¿ç”¨ç»Ÿä¸€æ ¼å¼åŒ–

---

## æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–ä¸»è¦å®Œæˆäº†ï¼š
1. âœ… æ¶ˆé™¤ä»£ç é‡å¤ï¼ˆ~150 è¡Œï¼‰
2. âœ… ç»Ÿä¸€é…ç½®ç³»ç»Ÿï¼ˆç¼“å­˜å¯é…ç½®ï¼‰
3. âœ… å¢å¼ºé”™è¯¯å¤„ç†ï¼ˆdebug æ—¥å¿—ï¼‰
4. âœ… æé«˜ä»£ç å¯ç»´æŠ¤æ€§

æ‰€æœ‰æ›´æ”¹å·²é€šè¿‡æ„å»ºå’ŒåŠŸèƒ½æµ‹è¯•ï¼Œä¿æŒå‘åå…¼å®¹ã€‚
